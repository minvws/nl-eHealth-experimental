<!DOCTYPE html>
<html lang="EN">
<head>
  <title>FHIR2QR</title>
  <style>
    body
    {
      background-color: thistle;
    }
  </style>
</head>
<script>
function import_url() {
    const te = document.getElementById('fhir');
    const ue = document.getElementById('url');
    const url = ue.value;

    console.log("fetching " + url);

    te.value="...fetching";
    fetch(url)
      .then(function(reply) {
          reply.text().then(function(payload) {
                te.value = payload;
          });
         console.log("ok");
      })
      .catch(function(err) {
         console.log("fetching " + url + " failed: "+err);
      });
    };
</script>
<body>
  <div>
    <h1>FHIR 2 QR</h1>
    <div>
      <label for="fhir_server">FHIR Server:</label>
      This queries the given FHIR server for Immunization resources, and will:
      <ol>
      <li>
      Fetch FHIR from <input id=url value="https://server.fire.ly/r4/"/> 
      by <button onclick="import_url()">importing</button> it.
<br/>
     <form action="/fhir2qr" method="post">
<textarea name=fhir id=fhir rows=20 cols=80>
{
   "timestamp" : "2021-03-28T21:38:18.958+00:00",
   "meta" : {
      "lastUpdated" : "2021-03-28T21:38:18.958+00:00",
      "versionId" : "7bc550da-4746-44ab-90b3-a8c506de00ed"
   },
   "resourceType" : "Bundle",
   "total" : 67,
   "type" : "searchset",
   "entry" : [
      {
         "resource" : {
            "meta" : {
               "lastUpdated" : "2021-03-26T08:41:33.516+00:00",
               "tag" : [
                  {
                     "system" : "http://hl7.org/fhir/v3/ObservationValue",
                     "code" : "SUBSETTED"
                  }
               ],
               "versionId" : "4323bc91-6779-4fca-9615-87ad7ff933e5"
            },
            "vaccineCode" : {
               "coding" : [
                  {
                     "code" : "151--influenza nasal, unspecified formulation"
                  }
               ]
            },
            "occurrenceDateTime" : "2021-03-10T00:00:00Z",
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patient/0e261b41-1e8b-eb11-a812-000d3a9d9ff8"
            },
            "id" : "c2f2cc47-c7c6-4797-a6e3-a67b8da2a646",
            "note" : [
               {
                  "text" : "Taken"
               }
            ],
            "status" : "completed",
            "route" : {
               "coding" : [
                  {
                     "display" : "Injection, intramuscular"
                  }
               ]
            },
            "resourceType" : "Immunization"
         },
         "fullUrl" : "https://server.fire.ly/r4/Immunization/c2f2cc47-c7c6-4797-a6e3-a67b8da2a646",
         "search" : {
            "mode" : "match"
         }
      },
      {
         "search" : {
            "mode" : "match"
         },
         "fullUrl" : "https://server.fire.ly/r4/Immunization/e14a1ae8-5254-460e-9c97-bd0447f70162",
         "resource" : {
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patinet/c76af6ad-81f7-4486-897f-c8d7782325d2"
            },
            "doseQuantity" : {
               "value" : 43,
               "code" : "mg",
               "system" : "http://unitsofmeasure.org"
            },
            "meta" : {
               "versionId" : "d1926769-6462-44c0-ad70-f137c58b44fe",
               "tag" : [
                  {
                     "code" : "SUBSETTED",
                     "system" : "http://hl7.org/fhir/v3/ObservationValue"
                  }
               ],
               "lastUpdated" : "2021-03-26T08:41:30.675+00:00"
            },
            "occurrenceDateTime" : "2021-03-10",
            "vaccineCode" : {
               "text" : "--influenza nasal, unspecified formulation",
               "coding" : [
                  {
                     "system" : "urn:oid:1.2.36.1.2001.1005.17",
                     "code" : "151"
                  }
               ]
            },
            "resourceType" : "Immunization",
            "id" : "e14a1ae8-5254-460e-9c97-bd0447f70162",
            "status" : "completed",
            "note" : [
               {
                  "text" : "Taken"
               }
            ]
         }
      },
      {
         "fullUrl" : "https://server.fire.ly/r4/Immunization/041bd6a4-50da-4399-afe0-a88b72e2f80d",
         "search" : {
            "mode" : "match"
         },
         "resource" : {
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patient/be7601d2-0c8e-eb11-a812-000d3a9d9ff8"
            },
            "meta" : {
               "tag" : [
                  {
                     "code" : "SUBSETTED",
                     "system" : "http://hl7.org/fhir/v3/ObservationValue"
                  }
               ],
               "lastUpdated" : "2021-03-26T08:33:29.180+00:00",
               "versionId" : "e9ee227f-d9d5-445d-8eea-fdba63c0f30f"
            },
            "occurrenceDateTime" : "2021-03-09T00:00:00Z",
            "vaccineCode" : {
               "coding" : [
                  {
                     "code" : "135--Influenza, high dose seasonal"
                  }
               ]
            },
            "resourceType" : "Immunization",
            "route" : {
               "coding" : [
                  {
                     "display" : "Injection, intramuscular"
                  }
               ]
            },
            "id" : "041bd6a4-50da-4399-afe0-a88b72e2f80d",
            "note" : [
               {
                  "text" : "yyyyy"
               }
            ],
            "status" : "completed"
         }
      },
      {
         "fullUrl" : "https://server.fire.ly/r4/Immunization/9ddbe593-8576-4ded-bd1c-5016781cafcc",
         "search" : {
            "mode" : "match"
         },
         "resource" : {
            "route" : {
               "coding" : [
                  {
                     "display" : "Injection, intramuscular"
                  }
               ]
            },
            "resourceType" : "Immunization",
            "status" : "completed",
            "note" : [
               {
                  "text" : "yyyyy"
               }
            ],
            "id" : "9ddbe593-8576-4ded-bd1c-5016781cafcc",
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patient/be7601d2-0c8e-eb11-a812-000d3a9d9ff8"
            },
            "vaccineCode" : {
               "coding" : [
                  {
                     "code" : "151--influenza nasal, unspecified formulation"
                  }
               ]
            },
            "occurrenceDateTime" : "2021-03-09T00:00:00Z",
            "meta" : {
               "lastUpdated" : "2021-03-26T08:33:29.136+00:00",
               "tag" : [
                  {
                     "system" : "http://hl7.org/fhir/v3/ObservationValue",
                     "code" : "SUBSETTED"
                  }
               ],
               "versionId" : "b29eb455-494b-43b5-9f59-9523ae62cc37"
            }
         }
      },
      {
         "fullUrl" : "https://server.fire.ly/r4/Immunization/0b552fd9-b7cd-4b00-9d9c-cf6cd132e333",
         "search" : {
            "mode" : "match"
         },
         "resource" : {
            "doseQuantity" : {
               "system" : "http://unitsofmeasure.org",
               "value" : 55,
               "code" : "mg"
            },
            "occurrenceDateTime" : "2021-03-09",
            "vaccineCode" : {
               "coding" : [
                  {
                     "code" : "135",
                     "system" : "urn:oid:1.2.36.1.2001.1005.17"
                  }
               ],
               "text" : "--Influenza, high dose seasonal"
            },
            "meta" : {
               "versionId" : "4bdc6c71-2355-49c8-bc66-461c9cf82e59",
               "lastUpdated" : "2021-03-26T08:33:12.748+00:00",
               "tag" : [
                  {
                     "system" : "http://hl7.org/fhir/v3/ObservationValue",
                     "code" : "SUBSETTED"
                  }
               ]
            },
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patinet/67917df3-9e71-4e0c-acce-51ef8f7f37de"
            },
            "status" : "completed",
            "note" : [
               {
                  "text" : "yyyyy"
               }
            ],
            "id" : "0b552fd9-b7cd-4b00-9d9c-cf6cd132e333",
            "resourceType" : "Immunization"
         }
      },
      {
         "resource" : {
            "note" : [
               {
                  "text" : "yyyyy"
               }
            ],
            "status" : "completed",
            "id" : "1c849204-94e4-47be-9573-39f83b576d4e",
            "resourceType" : "Immunization",
            "doseQuantity" : {
               "code" : "mg",
               "value" : 55,
               "system" : "http://unitsofmeasure.org"
            },
            "vaccineCode" : {
               "text" : "--influenza nasal, unspecified formulation",
               "coding" : [
                  {
                     "code" : "151",
                     "system" : "urn:oid:1.2.36.1.2001.1005.17"
                  }
               ]
            },
            "occurrenceDateTime" : "2021-03-09",
            "meta" : {
               "versionId" : "ea7f51ed-7612-40ec-af03-de0f9761c1bb",
               "tag" : [
                  {
                     "code" : "SUBSETTED",
                     "system" : "http://hl7.org/fhir/v3/ObservationValue"
                  }
               ],
               "lastUpdated" : "2021-03-26T08:33:10.724+00:00"
            },
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patinet/67917df3-9e71-4e0c-acce-51ef8f7f37de"
            }
         },
         "search" : {
            "mode" : "match"
         },
         "fullUrl" : "https://server.fire.ly/r4/Immunization/1c849204-94e4-47be-9573-39f83b576d4e"
      },
      {
         "fullUrl" : "https://server.fire.ly/r4/Immunization/e3a5027a-4d8b-4229-adb0-91135a676be1",
         "search" : {
            "mode" : "match"
         },
         "resource" : {
            "patient" : {
               "reference" : "https://server.fire.ly/r4/67917df3-9e71-4e0c-acce-51ef8f7f37de"
            },
            "doseQuantity" : {
               "code" : "mg",
               "value" : 5,
               "system" : "http://unitsofmeasure.org"
            },
            "meta" : {
               "lastUpdated" : "2021-03-26T08:32:38.139+00:00",
               "tag" : [
                  {
                     "code" : "SUBSETTED",
                     "system" : "http://hl7.org/fhir/v3/ObservationValue"
                  }
               ],
               "versionId" : "96ed3276-64b4-409c-b76f-e560926a85ab"
            },
            "vaccineCode" : {
               "text" : "Patient",
               "coding" : [
                  {
                     "system" : "urn:oid:1.2.36.1.2001.1005.17"
                  }
               ]
            },
            "occurrenceDateTime" : "2021-03-08",
            "identifier" : [
               {
                  "system" : "abc"
               }
            ],
            "resourceType" : "Immunization",
            "id" : "e3a5027a-4d8b-4229-adb0-91135a676be1",
            "status" : "completed"
         }
      },
      {
         "resource" : {
            "id" : "69fedd75-2f65-45a5-861e-086080019214",
            "note" : [
               {
                  "text" : "buhbbbbbbbbbbbb"
               }
            ],
            "status" : "completed",
            "resourceType" : "Immunization",
            "route" : {
               "coding" : [
                  {
                     "display" : "Injection, intramuscular"
                  }
               ]
            },
            "meta" : {
               "versionId" : "05aac5b1-0afb-4665-bae4-ff2195aeff06",
               "tag" : [
                  {
                     "code" : "SUBSETTED",
                     "system" : "http://hl7.org/fhir/v3/ObservationValue"
                  }
               ],
               "lastUpdated" : "2021-03-24T08:49:03.992+00:00"
            },
            "vaccineCode" : {
               "coding" : [
                  {
                     "code" : "151--influenza nasal, unspecified formulation"
                  }
               ]
            },
            "occurrenceDateTime" : "2021-03-09T00:00:00Z",
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patient/0e261b41-1e8b-eb11-a812-000d3a9d9ff8"
            }
         },
         "search" : {
            "mode" : "match"
         },
         "fullUrl" : "https://server.fire.ly/r4/Immunization/69fedd75-2f65-45a5-861e-086080019214"
      },
      {
         "search" : {
            "mode" : "match"
         },
         "fullUrl" : "https://server.fire.ly/r4/Immunization/e3ae7e4f-b209-47c0-9ad6-af8609cb351d",
         "resource" : {
            "id" : "e3ae7e4f-b209-47c0-9ad6-af8609cb351d",
            "status" : "completed",
            "note" : [
               {
                  "text" : "buhbbbbbbbbbbbb"
               }
            ],
            "resourceType" : "Immunization",
            "doseQuantity" : {
               "value" : 7,
               "code" : "mg",
               "system" : "http://unitsofmeasure.org"
            },
            "meta" : {
               "lastUpdated" : "2021-03-24T08:48:49.955+00:00",
               "tag" : [
                  {
                     "code" : "SUBSETTED",
                     "system" : "http://hl7.org/fhir/v3/ObservationValue"
                  }
               ],
               "versionId" : "767735b4-33da-4004-be25-6bf15d0362ad"
            },
            "vaccineCode" : {
               "coding" : [
                  {
                     "code" : "151",
                     "system" : "urn:oid:1.2.36.1.2001.1005.17"
                  }
               ],
               "text" : "--influenza nasal, unspecified formulation"
            },
            "occurrenceDateTime" : "2021-03-09",
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patinet/c76af6ad-81f7-4486-897f-c8d7782325d2"
            }
         }
      },
      {
         "resource" : {
            "patient" : {
               "reference" : "https://server.fire.ly/r4/Patient/0e261b41-1e8b-eb11-a812-000d3a9d9ff8"
            },
            "meta" : {
               "versionId" : "9582c906-e524-43ab-8d83-56920873d7bc",
               "tag" : [
                  {
                     "system" : "http://hl7.org/fhir/v3/ObservationValue",
                     "code" : "SUBSETTED"
                  }
               ],
               "lastUpdated" : "2021-03-22T15:03:16.778+00:00"
            },
            "vaccineCode" : {
               "coding" : [
                  {
                     "code" : "160--Influenza A monovalent (H5N1), ADJUVANTED-2013"
                  }
               ]
            },
            "occurrenceDateTime" : "2021-03-21T00:00:00Z",
            "resourceType" : "Immunization",
            "route" : {
               "coding" : [
                  {
                     "display" : "Injection, intramuscular"
                  }
               ]
            },
            "id" : "96e9f38e-d826-4ec9-a0e1-95bcdeefec8f",
            "note" : [
               {
                  "text" : "shobhit vaccine"
               }
            ],
            "status" : "completed"
         },
         "search" : {
            "mode" : "match"
         },
         "fullUrl" : "https://server.fire.ly/r4/Immunization/96e9f38e-d826-4ec9-a0e1-95bcdeefec8f"
      }
   ],
   "link" : [
      {
         "relation" : "self",
         "url" : "https://server.fire.ly/r4/Immunization?date=ge2021-01-01&_sort=-_lastUpdated&_count=10&_skip=0&_summary=data"
      },
      {
         "url" : "https://server.fire.ly/r4/Immunization?date=ge2021-01-01&_sort=-_lastUpdated&_count=10&_skip=10&_summary=data",
         "relation" : "next"
      },
      {
         "url" : "https://server.fire.ly/r4/Immunization?date=ge2021-01-01&_sort=-_lastUpdated&_count=10&_skip=60&_summary=data",
         "relation" : "last"
      }
   ],
   "id" : "9fa310d2-a9fe-4a0c-bf30-78cc6bc2db06"
}
</textarea>
</li>
        <li>convert the returned JSON to an eHN Vaccination Minimum Data Set as per Annex 1
          <input type="submit" value="show" formaction="fhir2json"/>,
          </li>
        <li>semantically compress it,
        <li>serialize it,
          <input type="submit" value="show" formaction="fhir2jsoncbor"/>,
	</li>
        <li>digitally sign it <input type="submit" value="show" formaction="fhir2jsoncborcosezlib"/> with:
	<ul>
		<li> private key as a <a href="dsc-worker.key">PEM file</a> (<i>which you normally would not get!</i>).  </li>
		<li> and the KeyID of the DSCS certificate <a href="dsc-worker.pem">PEM file</a> (plain concatenation; not a LDIFF).  </li>
		<li> Which is on this Country DSCS list, available as <a href="masterlist-dsc.pem">PEM file</a>.  </li>
		<li> And which is signed by the Country CSCA, availablea <a href="csca.pem">PEM file</a>.  </li>
	</ul>
        </li>
        <li>LZMA compress it,
          <input type="submit" value="show" formaction="fhir2jsoncborcosezlib"/>,
	</li>
        <li><a href="https://tools.ietf.org/html/draft-faltstrom-base45-02">Base45</a> encode it
          <input type="submit" value="show" formaction="fhir2jsoncborcosezlibb45"/>,
	</li>
        <li> and finally generate QR code from it
         <input type="submit" value="show qr" formaction="fhir2jsoncborcosezlibb45qr"/>.
	</li>
      </ol>
      <p>Or 
         <input type="submit" value="show the sizes" formaction="fhir2size"/> after each step.
    </form>
  </div>
</body>
</html>
